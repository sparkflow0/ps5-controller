<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PS5 Controller Configurator â€“ Mask-based Picking</title>
  <style>
    :root { --bg: #151515; }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent; /* hide blue tap highlight on mobile */
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: radial-gradient(circle at top, #2b2b2b 0, #0b0b0b 55%, #000 100%);
      color: #fff;
    }

    button {
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    /* Wrapper with no background, radius, or shadow */
    .controller-wrapper {
      padding: 16px;
      position: relative;
      overflow: hidden;
      max-width: 1166px; /* your PNG width */
      width: 90vw;
    }

    .controller-area {
      position: relative;
      width: 100%;
      aspect-ratio: 1166 / 768; /* your PNG ratio */
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }

    .controller-area img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      user-select: none;
      pointer-events: none;
      filter: drop-shadow(0 18px 28px rgba(0,0,0,0.8));
    }

    /* Masked color layers (visual only) */
    .part-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .part-layer::before {
      content: "";
      position: absolute;
      inset: 0;
      background: var(--tint, transparent);
      mix-blend-mode: multiply;
      opacity: 0.95;

      -webkit-mask-image: var(--mask-url);
      mask-image: var(--mask-url);
      -webkit-mask-repeat: no-repeat;
      mask-repeat: no-repeat;
      -webkit-mask-size: contain;
      mask-size: contain;
      -webkit-mask-position: center;
      mask-position: center;
    }

    /* Mask-shaped glow when selected */
    .part-layer.selected::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at center,
                  rgba(255,255,255,0.9),
                  rgba(255,255,255,0) 60%);
      -webkit-mask-image: var(--mask-url);
      mask-image: var(--mask-url);
      -webkit-mask-repeat: no-repeat;
      mask-repeat: no-repeat;
      -webkit-mask-size: contain;
      mask-size: contain;
      -webkit-mask-position: center;
      mask-position: center;
      mix-blend-mode: screen;
      filter:
        drop-shadow(0 0 12px rgba(255,255,255,0.9))
        drop-shadow(0 0 22px rgba(0,0,0,0.9));
      opacity: 0.7;
      animation: breathe 1.8s ease-in-out infinite;
      pointer-events: none;
    }

    @keyframes breathe {
      0%, 100% { opacity: 0.55; transform: scale(1); }
      50%      { opacity: 1;    transform: scale(1.03); }
    }

    .part-layer.apply-flash::before {
      animation: applyFlash 0.45s ease-out;
    }

    @keyframes applyFlash {
      0%   { filter: brightness(2); }
      100% { filter: brightness(1); }
    }

    /* ---------- Color wheel ---------- */

    .swatch-host {
      position: absolute;
      width: 0;
      height: 0;
      pointer-events: none;
    }

    .swatch-group {
      position: absolute;
      left: 0;
      top: 0;
      pointer-events: none;
      animation: ringSpin 0.45s ease-out;
      transform-origin: center;
    }

    @keyframes ringSpin {
      0%   { transform: rotate(-6deg); }
      100% { transform: rotate(0deg); }
    }

    .swatch-line {
      position: absolute;
      left: 0;
      top: 0;
      width: 2px;
      height: var(--length, 80px);
      background: linear-gradient(
        to bottom,
        rgba(255, 255, 255, 0.4),
        rgba(255, 255, 255, 0.05)
      );
      opacity: 0;
      transform-origin: center top;
      transform: rotate(var(--angle, 0deg)) scaleY(0.05);
      pointer-events: none;
      filter: drop-shadow(0 0 4px rgba(0,0,0,0.8));
      animation: line-out 0.45s cubic-bezier(0.25, 0.9, 0.25, 1) forwards;
      will-change: transform, opacity;
    }

    .swatch {
      --dx: 0px;
      --dy: 0px;
      position: absolute;
      left: 0;
      top: 0;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      cursor: pointer;
      pointer-events: auto;
      outline: none;
      border: 1px solid rgba(255,255,255,0.22);
      box-shadow:
        0 10px 25px rgba(0,0,0,0.85),
        0 3px 6px rgba(0,0,0,0.7),
        0 0 0 1px rgba(0,0,0,0.9) inset,
        0 0 8px rgba(255,255,255,0.35) inset;
      background-image:
        radial-gradient(circle at 28% 28%, rgba(255,255,255,0.5), rgba(255,255,255,0) 60%),
        radial-gradient(circle at 70% 80%, rgba(255,255,255,0.2), rgba(0,0,0,0.4));
      opacity: 0;
      transform: translate(var(--dx), var(--dy)) scale(1);
      animation: swatch-out 0.45s cubic-bezier(0.22, 0.9, 0.25, 1) forwards;
      transition:
        transform 0.22s cubic-bezier(0.16, 0.84, 0.44, 1),
        box-shadow 0.22s ease,
        filter 0.22s ease;
      will-change: transform, opacity;
    }

    .swatch.gold-rim {
      box-shadow:
        0 10px 25px rgba(0,0,0,0.9),
        0 0 0 1px rgba(0,0,0,1) inset,
        0 0 0 2px rgba(255,215,128,0.95),
        0 0 10px rgba(255,230,160,0.8),
        0 0 10px rgba(255,255,255,0.7) inset;
    }

    .swatch:hover {
      transform: translate(var(--dx), var(--dy)) scale(1.16);
      box-shadow:
        0 18px 32px rgba(0,0,0,1),
        0 0 0 1px rgba(0,0,0,1) inset,
        0 0 0 2px rgba(255,255,255,0.3),
        0 0 16px rgba(255,255,255,0.9) inset,
        0 0 20px rgba(255,255,255,0.9);
      filter: saturate(1.2);
    }

    @keyframes swatch-out {
      0%   { opacity: 0; transform: translate(0,0) scale(0.05); }
      60%  { opacity: 1; transform: translate(calc(var(--dx)*1.05), calc(var(--dy)*1.05)) scale(1.08); }
      100% { opacity: 1; transform: translate(var(--dx), var(--dy)) scale(1); }
    }

    @keyframes swatch-in {
      0%   { opacity: 1; transform: translate(var(--dx), var(--dy)) scale(1); }
      45%  { opacity: 1; transform: translate(calc(var(--dx)*0.35), calc(var(--dy)*0.35)) scale(0.9); }
      100% { opacity: 0; transform: translate(0,0) scale(0.03); }
    }

    @keyframes line-out {
      0%   { opacity: 0; transform: rotate(var(--angle)) scaleY(0.05); }
      70%  { opacity: 1; transform: rotate(var(--angle)) scaleY(1.05); }
      100% { opacity: 1; transform: rotate(var(--angle)) scaleY(1); }
    }

    @keyframes line-in {
      0%   { opacity: 1; transform: rotate(var(--angle)) scaleY(1); }
      100% { opacity: 0; transform: rotate(var(--angle)) scaleY(0.05); }
    }

    .swatch-group.closing .swatch {
      animation: swatch-in 0.5s cubic-bezier(0.36, 0.0, 0.66, 1) forwards;
    }
    .swatch-group.closing .swatch-line {
      animation: line-in 0.5s cubic-bezier(0.36, 0.0, 0.66, 1) forwards;
    }
  </style>
</head>
<body>
  <div class="controller-wrapper">
    <div class="controller-area" id="controllerArea">
      <img src="controller.png" alt="PS5 Controller" />

      <!-- Masked layers for tint and highlight -->
      <div class="part-layer" data-part-id="leftShell"
           style="--mask-url: url('masks/leftShell.png');"></div>
      <div class="part-layer" data-part-id="rightShell"
           style="--mask-url: url('masks/rightShell.png');"></div>
      <div class="part-layer" data-part-id="centerBody"
           style="--mask-url: url('masks/centerBody.png');"></div>
      <div class="part-layer" data-part-id="touchpad"
           style="--mask-url: url('masks/touchpad.png');"></div>
      <div class="part-layer" data-part-id="bumperL"
           style="--mask-url: url('masks/bumperL.png');"></div>
      <div class="part-layer" data-part-id="bumperR"
           style="--mask-url: url('masks/bumperR.png');"></div>
      <div class="part-layer" data-part-id="dpad"
           style="--mask-url: url('masks/dpad.png');"></div>
      <div class="part-layer" data-part-id="faceButtons"
           style="--mask-url: url('masks/faceButtons.png');"></div>
      <div class="part-layer" data-part-id="share"
           style="--mask-url: url('masks/share.png');"></div>
      <div class="part-layer" data-part-id="options"
           style="--mask-url: url('masks/options.png');"></div>
      <div class="part-layer" data-part-id="stickL"
           style="--mask-url: url('masks/stickL.png');"></div>
      <div class="part-layer" data-part-id="stickR"
           style="--mask-url: url('masks/stickR.png');"></div>
      <div class="part-layer" data-part-id="psButton"
           style="--mask-url: url('masks/psButton.png');"></div>
      <div class="part-layer" data-part-id="speaker"
           style="--mask-url: url('masks/speaker.png');"></div>
    </div>
  </div>

  <script>
    const BASE_WIDTH  = 1166;
    const BASE_HEIGHT = 768;

    const PARTS = [
      { id: "psButton",     mask: "masks/psButton.png",     priority: 4 },
      { id: "share",        mask: "masks/share.png",        priority: 4 },
      { id: "options",      mask: "masks/options.png",      priority: 4 },
      { id: "speaker",      mask: "masks/speaker.png",      priority: 4 },
      { id: "dpad",         mask: "masks/dpad.png",         priority: 4 },
      { id: "faceButtons",  mask: "masks/faceButtons.png",  priority: 4 },
      { id: "stickL",       mask: "masks/stickL.png",       priority: 3 },
      { id: "stickR",       mask: "masks/stickR.png",       priority: 3 },
      { id: "touchpad",     mask: "masks/touchpad.png",     priority: 2 },
      { id: "bumperL",      mask: "masks/bumperL.png",      priority: 2 },
      { id: "bumperR",      mask: "masks/bumperR.png",      priority: 2 },
      { id: "centerBody",   mask: "masks/centerBody.png",   priority: 1 },
      { id: "leftShell",    mask: "masks/leftShell.png",    priority: 1 },
      { id: "rightShell",   mask: "masks/rightShell.png",   priority: 1 }
    ];

    const COLORS = [
      "#ffffff", "#f5f5f5", "#000000", "#cccccc", "#777777",
      "#00b0ff", "#ff4081", "#7c4dff", "#69f0ae",
      "#ff1744", "#ff9100", "#ffc400", "#2979ff", "#00e676"
    ];

    const controllerArea = document.getElementById("controllerArea");
    const layers = Array.from(document.querySelectorAll(".part-layer"));
    const layerById = {};
    layers.forEach(l => { layerById[l.dataset.partId] = l; });

    const maskDataById = {};
    let masksReady = false;

    function loadMask(part) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.src = part.mask;
        img.onload = () => {
          const canvas = document.createElement("canvas");
          canvas.width = img.naturalWidth;
          canvas.height = img.naturalHeight;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          maskDataById[part.id] = {
            width: canvas.width,
            height: canvas.height,
            data: imageData.data
          };
          resolve();
        };
        img.onerror = reject;
      });
    }

    Promise.all(PARTS.map(loadMask)).then(() => {
      masksReady = true;
    }).catch(err => {
      console.error("Error loading masks:", err);
    });

    let selectedPartId = null;
    let swatchHost = null;
    let activeSwatchGroup = null;

    const configState = {};
    PARTS.forEach(p => { configState[p.id] = null; });

    function clearSelection() {
      if (!selectedPartId) return;
      const layer = layerById[selectedPartId];
      if (layer) layer.classList.remove("selected");
      selectedPartId = null;
    }

    function closeSwatchGroupAnimated(cb) {
      if (!activeSwatchGroup) { cb && cb(); return; }
      const group = activeSwatchGroup;
      group.classList.add("closing");
      activeSwatchGroup = null;
      setTimeout(() => {
        if (swatchHost) {
          swatchHost.remove();
          swatchHost = null;
        }
        cb && cb();
      }, 520);
    }

    function applyColor(partId, color) {
      configState[partId] = color;
      const layer = layerById[partId];
      if (!layer) return;
      layer.style.setProperty("--tint", color);
      layer.classList.add("apply-flash");
      layer.addEventListener("animationend", () => {
        layer.classList.remove("apply-flash");
      }, { once: true });
    }

    function showSwatches(partId, clickX, clickY) {
      closeSwatchGroupAnimated(() => {
        swatchHost = document.createElement("div");
        swatchHost.className = "swatch-host";
        swatchHost.style.left = `${clickX}px`;
        swatchHost.style.top  = `${clickY}px`;

        const group = document.createElement("div");
        group.className = "swatch-group";

        const n = COLORS.length;
        const radius = 80;
        const startAngle = -Math.PI / 2;

        COLORS.forEach((color, i) => {
          const angle = startAngle + (i / n) * 2 * Math.PI;
          const dx = Math.cos(angle) * radius;
          const dy = Math.sin(angle) * radius;

          const line = document.createElement("div");
          line.classList.add("swatch-line");
          line.style.setProperty("--length", `${radius}px`);
          line.style.setProperty("--angle", `${angle}rad`);
          line.style.animationDelay = `${i * 18}ms`;
          group.appendChild(line);

          const swatch = document.createElement("button");
          swatch.classList.add("swatch");
          swatch.style.background = color;
          swatch.style.setProperty("--dx", `${dx}px`);
          swatch.style.setProperty("--dy", `${dy}px`);
          swatch.style.animationDelay = `${i * 18}ms`;

          if (["#ffc400","#ffea00","#d4af37"].includes(color)) {
            swatch.classList.add("gold-rim");
          }

          swatch.addEventListener("click", (e) => {
            e.stopPropagation();
            applyColor(partId, color);
            clearSelection();
            closeSwatchGroupAnimated();
          });

          group.appendChild(swatch);
        });

        swatchHost.appendChild(group);
        controllerArea.appendChild(swatchHost);
        activeSwatchGroup = group;
      });
    }

    function hitTestPart(designX, designY) {
      const sorted = [...PARTS].sort((a, b) => b.priority - a.priority);

      for (const part of sorted) {
        const mask = maskDataById[part.id];
        if (!mask) continue;

        const x = Math.floor(designX / BASE_WIDTH  * mask.width);
        const y = Math.floor(designY / BASE_HEIGHT * mask.height);
        if (x < 0 || y < 0 || x >= mask.width || y >= mask.height) continue;

        const idx = (y * mask.width + x) * 4 + 3;
        const alpha = mask.data[idx];
        if (alpha > 20) return part.id;
      }
      return null;
    }

    controllerArea.addEventListener("click", (e) => {
      if (!masksReady) return;

      const rect = controllerArea.getBoundingClientRect();
      const relX = (e.clientX - rect.left) / rect.width;
      const relY = (e.clientY - rect.top)  / rect.height;

      if (relX < 0 || relX > 1 || relY < 0 || relY > 1) {
        closeSwatchGroupAnimated();
        clearSelection();
        return;
      }

      const designX = relX * BASE_WIDTH;
      const designY = relY * BASE_HEIGHT;

      const partId = hitTestPart(designX, designY);

      if (!partId) {
        closeSwatchGroupAnimated();
        clearSelection();
        return;
      }

      if (selectedPartId && selectedPartId !== partId) {
        const prevLayer = layerById[selectedPartId];
        if (prevLayer) prevLayer.classList.remove("selected");
      }
      selectedPartId = partId;
      const layer = layerById[partId];
      if (layer) layer.classList.add("selected");

      showSwatches(partId, e.clientX - rect.left, e.clientY - rect.top);
    });

    document.addEventListener("click", (e) => {
      if (!controllerArea.contains(e.target)) {
        closeSwatchGroupAnimated();
        clearSelection();
      }
    });
  </script>
</body>
</html>
