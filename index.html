<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PS5 Controller Configurator â€“ Per-Part Palettes with Audio</title>
  <style>
    :root {
      --bg: #151515;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body,
    button {
      -webkit-tap-highlight-color: transparent !important;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      background: radial-gradient(circle at top, #05060b 0, #020308 50%, #000 100%);
      color: #fff;
      overflow-x: hidden;
      overflow-y: auto;
      padding: 12px 0 24px;
    }

    #bgCanvas {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      pointer-events: none;
      display: block;
    }

    button {
      border: none;
      background: none;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    img {
      user-select: none;
    }

    .controller-wrapper {
      width: 92vw;
      max-width: 1166px;
      margin: 0 auto;
      position: relative;
    }

    .controller-area {
      position: relative;
      width: 100%;
      aspect-ratio: 1166 / 768;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      touch-action: manipulation;
      transform-origin: center;
    }

    .controller-area img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      filter: drop-shadow(0 18px 28px rgba(0, 0, 0, 0.9));
      pointer-events: none;
    }

    .part-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .part-layer::before {
      content: "";
      position: absolute;
      inset: 0;
      background: var(--tint, transparent);
      opacity: var(--tint-opacity, 1);
      filter: brightness(1.45) saturate(1.4) contrast(1.05);
      mix-blend-mode: overlay;
      -webkit-mask-image: var(--mask-url);
      mask-image: var(--mask-url);
      -webkit-mask-repeat: no-repeat;
      mask-repeat: no-repeat;
      -webkit-mask-size: contain;
      mask-size: contain;
      -webkit-mask-position: center;
      mask-position: center;
    }

    .part-layer.selected::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at center,
          rgba(255, 255, 255, 0.9),
          rgba(255, 255, 255, 0) 60%);
      -webkit-mask-image: var(--mask-url);
      mask-image: var(--mask-url);
      -webkit-mask-repeat: no-repeat;
      mask-repeat: no-repeat;
      -webkit-mask-size: contain;
      mask-size: contain;
      -webkit-mask-position: center;
      mask-position: center;
      mix-blend-mode: screen;
      filter:
        drop-shadow(0 0 12px rgba(255, 255, 255, 0.9)) drop-shadow(0 0 22px rgba(0, 0, 0, 0.9));
      opacity: 0.7;
      animation: breathe 1.8s ease-in-out infinite;
      pointer-events: none;
    }

    @keyframes breathe {

      0%,
      100% {
        opacity: 0.55;
        transform: scale(1);
      }

      50% {
        opacity: 1;
        transform: scale(1.03);
      }
    }

    /* .part-layer.apply-flash::before {
      animation: applyFlash 0.45s ease-out;
    }

    @keyframes applyFlash {
      0% {
        filter: brightness(2.5)
      }

      100% {
        filter: brightness(1)
      }
    } */

    /* ---------------- BOTTOM SHEET ---------------- */

    .sheet-backdrop {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.9));
      display: flex;
      align-items: flex-end;
      justify-content: center;
      z-index: 30;
      animation: sheet-fade-in 0.16s ease-out forwards;
    }

    @keyframes sheet-fade-in {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .sheet-backdrop.hide {
      animation: sheet-fade-out 0.18s ease-in forwards;
    }

    @keyframes sheet-fade-out {
      to {
        opacity: 0;
      }
    }

    .color-sheet {
      width: 100%;
      max-width: 1166px;
      max-height: 72vh;
      background: radial-gradient(circle at top,
          rgba(255, 255, 255, 0.06),
          rgba(5, 5, 5, 0.98));
      border-radius: 24px 24px 0 0;
      border-top: 1px solid rgba(255, 255, 255, 0.14);
      box-shadow:
        0 -20px 40px rgba(0, 0, 0, 0.9),
        0 0 0 1px rgba(255, 255, 255, 0.04);
      padding: 12px 18px 18px;
      transform: translateY(100%);
      animation: sheet-slide-up 0.22s ease-out forwards;
    }

    @keyframes sheet-slide-up {
      to {
        transform: translateY(0);
      }
    }

    .color-sheet.hide {
      animation: sheet-slide-down 0.22s ease-in forwards;
    }

    @keyframes sheet-slide-down {
      to {
        transform: translateY(100%);
      }
    }

    .sheet-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
    }

    .sheet-handle {
      width: 44px;
      height: 4px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.35);
    }

    .sheet-title {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      opacity: 0.84;
    }

    .sheet-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 14px;
      padding-right: 4px;
      overflow-y: auto;
      max-height: calc(72vh - 80px);
    }

    .sheet-cell {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      font-size: 0.72rem;
      text-align: center;
      opacity: 0.9;
    }

    .sheet-color-name {
      max-width: 80px;
      line-height: 1.15;
      word-break: break-word;
    }

    .sheet-swatch {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.35);
      background-image:
        radial-gradient(circle at 28% 24%,
          rgba(255, 255, 255, 0.8),
          rgba(255, 255, 255, 0.1) 40%,
          rgba(255, 255, 255, 0) 60%),
        radial-gradient(circle at 76% 80%,
          rgba(255, 255, 255, 0.15),
          rgba(0, 0, 0, 0.55) 65%,
          rgba(0, 0, 0, 0.9) 100%);
      box-shadow:
        0 18px 30px rgba(0, 0, 0, 0.95),
        0 6px 12px rgba(0, 0, 0, 0.85),
        0 0 0 2px rgba(0, 0, 0, 1) inset,
        0 10px 18px rgba(0, 0, 0, 0.98) inset,
        0 -4px 8px rgba(255, 255, 255, 0.55) inset;
      cursor: pointer;
      transition:
        transform 0.12s ease-out,
        box-shadow 0.12s ease-out,
        filter 0.12s ease-out;
    }

    .sheet-swatch:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow:
        0 24px 40px rgba(0, 0, 0, 1),
        0 0 0 2px rgba(0, 0, 0, 1) inset,
        0 18px 30px rgba(0, 0, 0, 1) inset,
        0 -8px 12px rgba(255, 255, 255, 1) inset,
        0 0 28px rgba(255, 255, 255, 0.95);
      filter: brightness(1.9) saturate(2.0) contrast(1.1);
    }

    /* ---------------- SUMMARY ---------------- */

    .summary-bar {
      margin-top: 24px;
      padding: 14px 18px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: radial-gradient(circle at top,
          rgba(255, 255, 255, 0.04),
          rgba(0, 0, 0, 0.9));
      box-shadow:
        0 18px 36px rgba(0, 0, 0, 0.9),
        0 0 0 1px rgba(255, 255, 255, 0.04);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .summary-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .summary-label {
      font-size: 0.9rem;
      opacity: 0.75;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .summary-amount {
      font-size: 1.4rem;
      font-weight: 600;
    }

    .add-to-cart-btn {
      padding: 10px 20px;
      border-radius: 999px;
      background: linear-gradient(135deg, #00e5ff, #2979ff);
      color: #fff;
      font-size: 0.95rem;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      cursor: pointer;
      box-shadow:
        0 14px 28px rgba(0, 0, 0, 0.9),
        0 0 18px rgba(0, 229, 255, 0.7);
      white-space: nowrap;
      transition: transform 0.16s ease, box-shadow 0.16s ease, filter 0.16s ease;
    }

    .add-to-cart-btn:hover {
      transform: translateY(-1px);
      box-shadow:
        0 20px 40px rgba(0, 0, 0, 1),
        0 0 24px rgba(0, 229, 255, 0.9);
      filter: brightness(1.1);
    }

    .add-to-cart-btn:active {
      transform: translateY(1px) scale(0.98);
      box-shadow:
        0 8px 20px rgba(0, 0, 0, 0.8),
        0 0 14px rgba(0, 229, 255, 0.7);
    }

    @media (max-width: 900px) {
      body {
        padding-top: 6px;
      }

      .controller-wrapper {
        width: 100vw;
        max-width: 100vw;
        padding: 0 6px;
      }

      .summary-bar {
        margin-top: 18px;
        padding: 12px 14px;
      }

      .summary-amount {
        font-size: 1.3rem;
      }

      .add-to-cart-btn {
        padding: 9px 16px;
      }
    }
  </style>
</head>

<body>
  <canvas id="bgCanvas"></canvas>

  <!-- Audio elements -->
  <audio id="sfxClick" src="sounds/click.mp3" preload="auto"></audio>
  <audio id="sfxSlide" src="sounds/slide.mp3" preload="auto"></audio>
  <audio id="sfxClick2" src="sounds/click2.mp3" preload="auto"></audio>

  <div class="controller-wrapper" id="controllerWrapper">
    <div class="controller-area" id="controllerArea">
      <img src="controller.png" alt="PS5 Controller" />

      <!-- Masked layers -->
      <div class="part-layer" data-part-id="leftShell" style="--mask-url: url('masks/leftShell.png');"></div>
      <div class="part-layer" data-part-id="rightShell" style="--mask-url: url('masks/rightShell.png');"></div>
      <div class="part-layer" data-part-id="centerBody" style="--mask-url: url('masks/centerBody.png');"></div>
      <div class="part-layer" data-part-id="touchpad" style="--mask-url: url('masks/touchpad.png');"></div>
      <div class="part-layer" data-part-id="bumperL" style="--mask-url: url('masks/bumperL.png');"></div>
      <div class="part-layer" data-part-id="bumperR" style="--mask-url: url('masks/bumperR.png');"></div>
      <div class="part-layer" data-part-id="dpad" style="--mask-url: url('masks/dpad.png');"></div>
      <div class="part-layer" data-part-id="faceButtons" style="--mask-url: url('masks/faceButtons.png');"></div>
      <div class="part-layer" data-part-id="share" style="--mask-url: url('masks/share.png');"></div>
      <div class="part-layer" data-part-id="options" style="--mask-url: url('masks/options.png');"></div>
      <div class="part-layer" data-part-id="stickL" style="--mask-url: url('masks/stickL.png');"></div>
      <div class="part-layer" data-part-id="stickR" style="--mask-url: url('masks/stickR.png');"></div>
      <div class="part-layer" data-part-id="psButton" style="--mask-url: url('masks/psButton.png');"></div>
      <div class="part-layer" data-part-id="speaker" style="--mask-url: url('masks/speaker.png');"></div>
    </div>

    <div class="summary-bar">
      <div class="summary-text">
        <span class="summary-label">Configuration total</span>
        <span class="summary-amount" id="summaryAmount">BHD 0.00</span>
      </div>
      <button class="add-to-cart-btn" id="addToCartBtn">ADD TO CART</button>
    </div>
  </div>

  <script>
    const isMobile =
      /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent) ||
      window.innerWidth < 768;

    /* ---------- SFX helpers ---------- */
    const sfxClickEl = document.getElementById("sfxClick");
    const sfxSlideEl = document.getElementById("sfxSlide");
    const sfxClick2El = document.getElementById("sfxClick2");

    function playSfx(el) {
      if (!el) return;
      try {
        el.currentTime = 0;
        el.play();
      } catch (_) {
        // ignore playback errors (e.g., browser auto-play restrictions)
      }
    }

    function playClick() {
      playSfx(sfxClickEl);
    }

    function playSlide() {
      playSfx(sfxSlideEl);
    }

    function playClick2() {
      playSfx(sfxClick2El);
    }

    /* ---------- Background sci-fi lines (desktop only) ---------- */
    (function () {
      const canvas = document.getElementById("bgCanvas");
      if (isMobile) {
        canvas.style.display = "none";
        return;
      }
      const ctx = canvas.getContext("2d");
      let width = window.innerWidth;
      let height = window.innerHeight;

      function resize() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
      }
      resize();
      window.addEventListener("resize", resize);

      const LINE_COLORS = [
        { stroke: "rgba(0, 255, 255, 0.08)", glow: "rgba(0, 255, 255, 0.35)" },
        { stroke: "rgba(0, 180, 255, 0.08)", glow: "rgba(0, 180, 255, 0.35)" },
        { stroke: "rgba(140, 100, 255, 0.1)", glow: "rgba(140, 100, 255, 0.40)" },
        { stroke: "rgba(0, 255, 170, 0.08)", glow: "rgba(0, 255, 170, 0.35)" },
        { stroke: "rgba(255, 140, 0, 0.07)", glow: "rgba(255, 140, 0, 0.32)" }
      ];

      const LINE_COUNT = 65;
      const lines = [];

      function createLine() {
        const len = 100 + Math.random() * 260;
        const speed = 120 + Math.random() * 220;
        const thickness = 1 + Math.random() * 2;
        const color = LINE_COLORS[Math.floor(Math.random() * LINE_COLORS.length)];
        const startX = Math.random() * (width + height) - height;
        const startY = -len - Math.random() * height;
        return {
          x: startX,
          y: startY,
          len,
          speed,
          thickness,
          color,
          wiggleAmp: 10 + Math.random() * 30,
          wiggleFreq: 8 + Math.random() * 18,
          wiggleSpeed: 4 + Math.random() * 8,
          phase: Math.random() * Math.PI * 2
        };
      }

      for (let i = 0; i < LINE_COUNT; i++) lines.push(createLine());

      let lastTime = performance.now();
      function loop(now) {
        const dt = (now - lastTime) / 1000;
        lastTime = now;

        ctx.globalCompositeOperation = "source-over";
        ctx.fillStyle = "rgba(0, 0, 0, 0.18)";
        ctx.fillRect(0, 0, width, height);

        ctx.globalCompositeOperation = "lighter";
        lines.forEach((line, idx) => {
          const diagSpeed = line.speed;
          line.x += diagSpeed * dt * 0.7;
          line.y += diagSpeed * dt;
          line.phase += line.wiggleSpeed * dt;

          if (line.y - line.len > height || line.x - line.len > width) {
            lines[idx] = createLine();
            return;
          }

          const dx = line.len * 0.7;
          const dy = line.len;
          const segments = 12;

          ctx.save();
          ctx.strokeStyle = line.color.stroke;
          ctx.lineWidth = line.thickness;
          ctx.shadowColor = line.color.glow;
          ctx.shadowBlur = 18 + Math.random() * 10;
          ctx.beginPath();

          for (let i = 0; i <= segments; i++) {
            const t = i / segments;
            const baseX = line.x - dx * t;
            const baseY = line.y - dy * t;
            const wobble = line.wiggleAmp * Math.sin(line.phase + t * line.wiggleFreq);
            const px = baseX + wobble;
            const py = baseY + wobble * 0.35;
            if (i === 0) ctx.moveTo(px, py);
            else ctx.lineTo(px, py);
          }

          ctx.stroke();
          ctx.restore();
        });

        requestAnimationFrame(loop);
      }

      requestAnimationFrame(loop);
    })();

    /* ---------- Controller + palettes ---------- */

    const BASE_WIDTH = 1166;
    const BASE_HEIGHT = 768;
    const CURRENCY = "BHD ";

    const PARTS = [
      { id: "psButton", mask: "masks/psButton.png", priority: 4 },
      { id: "share", mask: "masks/share.png", priority: 4 },
      { id: "options", mask: "masks/options.png", priority: 4 },
      { id: "speaker", mask: "masks/speaker.png", priority: 4 },
      { id: "dpad", mask: "masks/dpad.png", priority: 4 },
      { id: "faceButtons", mask: "masks/faceButtons.png", priority: 4 },
      { id: "stickL", mask: "masks/stickL.png", priority: 3 },
      { id: "stickR", mask: "masks/stickR.png", priority: 3 },
      { id: "touchpad", mask: "masks/touchpad.png", priority: 2 },
      { id: "bumperL", mask: "masks/bumperL.png", priority: 2 },
      { id: "bumperR", mask: "masks/bumperR.png", priority: 2 },
      { id: "centerBody", mask: "masks/centerBody.png", priority: 1 },
      { id: "leftShell", mask: "masks/leftShell.png", priority: 1 },
      { id: "rightShell", mask: "masks/rightShell.png", priority: 1 }
    ];

    const PRICES = {
      psButton: 4.0,
      share: 3.0,
      options: 3.0,
      speaker: 4.0,
      dpad: 6.0,
      faceButtons: 6.0,
      stickL: 5.0,
      stickR: 5.0,
      touchpad: 10.0,
      bumperL: 8.0,
      bumperR: 8.0,
      centerBody: 12.0,
      leftShell: 15.0,
      rightShell: 15.0
    };

    // Shell palette
    const SHELL_COLORS = [
      { hex: "#FF7A21", name: "Orange" },
      { hex: "#E6D63A", name: "Yellow" },
      { hex: "#6ECFFF", name: "Light Blue" },
      { hex: "#8E8E8E", name: "Steel Gray" },
      { hex: "#0C4BFF", name: "Blue" },
      { hex: "#001F63", name: "Midnight Blue" },
      { hex: "#C2185B", name: "Magenta" },
      { hex: "#F5F5F5", name: "Soft White" },
      { hex: "#D400A8", name: "Hot Pink" },
      { hex: "#0A0A0A", name: "Matte Black" }
    ];

    // Accessory palette
    const ACCESSORY_COLORS = [
      { hex: "#0A0A0A", name: "Black" },
      { hex: "#D8D8D8", name: "Light Gray" },
      { hex: "#C41E2E", name: "Red" },
      { hex: "#2B2C79", name: "Dark Blue-Purple" },
      { hex: "#F2D400", name: "Yellow" },
      { hex: "#E56A1E", name: "Orange" },
      { hex: "#A6DA8C", name: "Mint Green" },
      { hex: "#4A23A8", name: "Royal Purple" },
      { hex: "#E03875", name: "Hot Pink" },
      { hex: "#77CBF7", name: "Sky Blue" },
      { hex: "#C75AC9", name: "Pink-Violet" },
      { hex: "#5C2DAF", name: "Indigo Purple" },
      { hex: "#EDEDED", name: "Clear Transparent" },
      { hex: "#D43838", name: "Transparent Red" },
      { hex: "#2448B5", name: "Transparent Blue" },
      { hex: "#68D78B", name: "Transparent Green" },
      { hex: "#4E2B8C", name: "Transparent Purple" },
      { hex: "#4A4A4A", name: "Gunmetal Gray" },
      { hex: "#8C3B2F", name: "Transparent Brown" },
      { hex: "#E3E3E3", name: "Frosted White" }
    ];

    // Transparent colors set
    const TRANSPARENT_HEXES = new Set([
      "#EDEDED",
      "#D43838",
      "#2448B5",
      "#68D78B",
      "#4E2B8C",
      "#8C3B2F",
      "#E3E3E3"
    ].map(c => c.toLowerCase()));

    const SHELL_PART_IDS = new Set(["leftShell", "rightShell", "centerBody"]);

    function getPaletteForPart(partId) {
      return SHELL_PART_IDS.has(partId) ? SHELL_COLORS : ACCESSORY_COLORS;
    }

    const controllerArea = document.getElementById("controllerArea");
    const summaryAmountEl = document.getElementById("summaryAmount");
    const addToCartBtn = document.getElementById("addToCartBtn");

    const layers = Array.from(document.querySelectorAll(".part-layer"));
    const layerById = {};
    layers.forEach(l => { layerById[l.dataset.partId] = l; });

    const maskDataById = {};
    let masksReady = false;

    function loadMask(part) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.src = part.mask;
        img.onload = () => {
          const canvas = document.createElement("canvas");
          canvas.width = img.naturalWidth;
          canvas.height = img.naturalHeight;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          maskDataById[part.id] = {
            width: canvas.width,
            height: canvas.height,
            data: imageData.data
          };
          resolve();
        };
        img.onerror = reject;
      });
    }

    Promise.all(PARTS.map(loadMask)).then(() => {
      masksReady = true;
    }).catch(err => console.error("Error loading masks:", err));

    const configState = {};
    PARTS.forEach(p => { configState[p.id] = null; });

    let selectedPartId = null;
    let activeSheetBackdrop = null;

    function formatMoney(v) {
      return CURRENCY + v.toFixed(2);
    }

    function computeTotal() {
      let t = 0;
      for (const p of PARTS) {
        if (configState[p.id]) t += PRICES[p.id] || 0;
      }
      return t;
    }

    function updateSummary() {
      summaryAmountEl.textContent = formatMoney(computeTotal());
    }

    function applyColor(partId, colorHex) {
      configState[partId] = colorHex;
      const layer = layerById[partId];
      if (!layer) return;
      layer.style.setProperty("--tint", colorHex);

      if (TRANSPARENT_HEXES.has(colorHex.toLowerCase())) {
        layer.style.setProperty("--tint-opacity", "0.35");
      } else {
        layer.style.setProperty("--tint-opacity", "1");
      }

      layer.classList.add("apply-flash");
      layer.addEventListener("animationend", () => {
        layer.classList.remove("apply-flash");
      }, { once: true });
      updateSummary();
    }

    function clearSelection() {
      if (!selectedPartId) return;
      const layer = layerById[selectedPartId];
      if (layer) layer.classList.remove("selected");
      selectedPartId = null;
    }

    function closeSheet() {
      if (!activeSheetBackdrop) return;
      const backdrop = activeSheetBackdrop;
      const sheet = backdrop.querySelector(".color-sheet");
      backdrop.classList.add("hide");
      sheet.classList.add("hide");
      activeSheetBackdrop = null;
      clearSelection();
      setTimeout(() => {
        if (backdrop.parentNode) backdrop.parentNode.removeChild(backdrop);
      }, 240);
    }

    function openColorSheet() {
      if (!selectedPartId) return;

      if (activeSheetBackdrop) {
        closeSheet();
      }

      const palette = getPaletteForPart(selectedPartId);

      const backdrop = document.createElement("div");
      backdrop.className = "sheet-backdrop";

      const sheet = document.createElement("div");
      sheet.className = "color-sheet";

      const header = document.createElement("div");
      header.className = "sheet-header";
      header.innerHTML = `
        <div class="sheet-handle"></div>
        <div class="sheet-title">Choose color</div>
      `;
      sheet.appendChild(header);

      const gridEl = document.createElement("div");
      gridEl.className = "sheet-grid";

      palette.forEach(({ hex, name }) => {
        const cell = document.createElement("div");
        cell.className = "sheet-cell";

        const sw = document.createElement("button");
        sw.className = "sheet-swatch";
        sw.style.backgroundColor = hex;
        sw.addEventListener("click", (e) => {
          e.stopPropagation();
          if (selectedPartId) {
            applyColor(selectedPartId, hex);
            playClick2(); // color selected
          }
          closeSheet();
        });

        const label = document.createElement("div");
        label.className = "sheet-color-name";
        label.textContent = name;

        cell.appendChild(sw);
        cell.appendChild(label);
        gridEl.appendChild(cell);
      });

      sheet.appendChild(gridEl);
      backdrop.appendChild(sheet);
      document.body.appendChild(backdrop);
      activeSheetBackdrop = backdrop;

      // play slide sound when sheet opens
      playSlide();

      // tap outside sheet to close
      backdrop.addEventListener("click", (e) => {
        if (e.target === backdrop) {
          closeSheet();
        }
      });

      // drag down to close
      let startY = null;
      let dragging = false;
      sheet.addEventListener("pointerdown", (e) => {
        startY = e.clientY;
        dragging = true;
      });
      sheet.addEventListener("pointermove", (e) => {
        if (!dragging || startY === null) return;
        const dy = e.clientY - startY;
        if (dy > 60) {
          dragging = false;
          closeSheet();
        }
      });
      sheet.addEventListener("pointerup", () => { dragging = false; startY = null; });
      sheet.addEventListener("pointercancel", () => { dragging = false; startY = null; });
    }

    function hitTestPart(designX, designY) {
      const sorted = [...PARTS].sort((a, b) => b.priority - a.priority);
      for (const part of sorted) {
        const mask = maskDataById[part.id];
        if (!mask) continue;
        const x = Math.floor(designX / BASE_WIDTH * mask.width);
        const y = Math.floor(designY / BASE_HEIGHT * mask.height);
        if (x < 0 || y < 0 || x >= mask.width || y >= mask.height) continue;
        const idx = (y * mask.width + x) * 4 + 3;
        const alpha = mask.data[idx];
        if (alpha > 20) return part.id;
      }
      return null;
    }

    controllerArea.addEventListener("click", (e) => {
      if (!masksReady) return;

      const rect = controllerArea.getBoundingClientRect();
      const relX = (e.clientX - rect.left) / rect.width;
      const relY = (e.clientY - rect.top) / rect.height;

      if (relX < 0 || relX > 1 || relY < 0 || relY > 1) {
        closeSheet();
        return;
      }

      const designX = relX * BASE_WIDTH;
      const designY = relY * BASE_HEIGHT;

      const partId = hitTestPart(designX, designY);
      if (!partId) {
        closeSheet();
        return;
      }

      if (selectedPartId && selectedPartId !== partId) {
        const prev = layerById[selectedPartId];
        if (prev) prev.classList.remove("selected");
      }

      selectedPartId = partId;
      const layer = layerById[partId];
      if (layer) layer.classList.add("selected");

      // play click sound when a component is selected
      playClick();

      openColorSheet();
    });

    /* ---------- Summary & cart ---------- */

    updateSummary();

    addToCartBtn.addEventListener("click", () => {
      const total = computeTotal();
      if (total <= 0) {
        alert("No custom options selected yet.");
        return;
      }
      alert("Configuration added to cart.\nTotal: " + formatMoney(total));
    });
  </script>
</body>

</html>
